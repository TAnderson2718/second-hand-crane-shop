<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>二手吊车小程序 (用户端+管理端)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- 通用样式 --- */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: #E5E7EB;
        }

        /* --- 手机视图样式 --- */
        .mobile-container {
             display: flex;
             justify-content: center;
             align-items: center;
             padding: 2rem;
             min-height: 100vh;
        }
        .mobile-frame {
            width: 100%;
            max-width: 420px;
            height: 850px;
            background-color: #F4F4F4;
            border: 12px solid #1F2937;
            border-radius: 40px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }
        .status-bar {
            height: 30px;
            background-color: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            font-size: 14px;
            color: #1F2937;
            flex-shrink: 0;
            border-bottom: 1px solid #E5E7EB;
        }
        .status-bar .time { font-weight: 600; }
        .status-bar .icons span { margin-left: 5px; }
        .screen {
            flex-grow: 1;
            overflow-y: auto;
            position: relative;
        }
        .screen::-webkit-scrollbar { display: none; }
        .page {
            display: none;
            flex-direction: column;
            background-color: #F4F4F4;
            animation: fadeIn 0.3s ease-in-out;
            min-height: 100%;
        }
        .page.active { display: flex; }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }
        .tab-bar, #detail-action-bar {
            height: 60px;
            background-color: #FFFFFF;
            border-top: 1px solid #E5E7EB;
            flex-shrink: 0;
            z-index: 10;
        }
        .tab-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #6B7280;
            cursor: pointer;
            transition: color 0.2s;
            flex: 1;
        }
        .tab-item.active { color: #3B82F6; }
        .tab-item svg { width: 24px; height: 24px; margin-bottom: 2px; }
        .nav-bar {
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            height: 44px;
            background-color: #fff;
            border-bottom: 1px solid #E5E7EB;
            flex-shrink: 0;
            z-index: 10;
        }
        .nav-bar .back-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
        }
        .nav-bar .title { font-size: 18px; font-weight: 600; }
        .image-preview-item { position: relative; }
        .delete-preview-btn {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            background-color: #EF4444;
            color: white;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            line-height: 1;
            cursor: pointer;
            border: 1px solid white;
        }
        .form-select, .form-input, .form-textarea {
            background-color: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            font-size: 14px;
            width: 100%;
        }
        .carousel-container {
            scroll-snap-type: x mandatory;
            overflow-x: auto;
        }
        .carousel-slide { scroll-snap-align: start; }
        .modal { animation: fadeInModal 0.3s ease-out; }
         @keyframes fadeInModal {
            from { opacity: 0; transform: translateY(30px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .post-action-btn { @apply text-sm text-gray-600 bg-gray-100 px-3 py-1 rounded-full; }

        /* --- 管理端样式 --- */
        .admin-view {
            width: 100%;
            min-height: 100vh;
            display: flex;
        }
        .sidebar {
            width: 250px;
            background-color: #1F2937;
            color: #D1D5DB;
            flex-shrink: 0;
        }
        .sidebar-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .sidebar-item:hover, .sidebar-item.active {
            background-color: #374151;
            color: white;
        }
        .sidebar-item svg {
            width: 20px;
            height: 20px;
            margin-right: 0.75rem;
        }
        .main-content {
            flex-grow: 1;
            padding: 2rem;
            background-color: #F3F4F6;
        }
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .status-reviewing, .status-banned { background-color: #FEF3C7; color: #92400E; }
        .status-selling, .status-active { background-color: #D1FAE5; color: #065F46; }
        .status-off { background-color: #E5E7EB; color: #4B5563; }
        
        .action-btn {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            transition: background-color 0.2s;
            margin: 0 0.2rem;
        }
    </style>
</head>
<body>
    
    <!-- 全局视图切换按钮 -->
    <div class="fixed top-4 right-4 z-50">
        <button id="view-toggle-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg shadow-lg hover:bg-indigo-700 transition">
            切换到管理员视图
        </button>
    </div>

    <!-- 用户手机视图 -->
    <div id="user-view">
        <div class="mobile-container">
            <div class="mobile-frame">
                 <!-- 状态栏 -->
                <div class="status-bar">
                    <span id="time" class="time">17:15</span>
                    <div class="icons"><span>📶</span><span>5G</span><span>🔋</span></div>
                </div>

                <!-- 导航栏 -->
                <div id="nav-bar" class="nav-bar hidden">
                    <div id="back-button" class="back-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                    </div>
                    <span id="nav-title" class="title"></span>
                </div>
                
                <!-- 屏幕内容区 -->
                <div id="screen" class="screen">
                    <!-- 各个页面容器 -->
                    <div id="page-index" class="page active"></div>
                    <div id="page-detail" class="page"></div>
                    <div id="page-post" class="page"></div>
                    <div id="page-profile" class="page"></div>
                    <div id="page-report" class="page"></div>
                    <div id="page-favorites" class="page"></div>
                    <div id="page-posts" class="page"></div>
                    <div id="page-intentions" class="page"></div>
                </div>

                <!-- 详情页专属操作栏 -->
                <div id="detail-action-bar" class="hidden"></div>
                
                <!-- 底部 Tab 栏 -->
                <div id="tab-bar" class="tab-bar flex">
                    <div class="tab-item active" data-page="index"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"></path></svg><span>首页</span></div>
                    <div class="tab-item" data-page="post"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"></path></svg><span>发布</span></div>
                    <div class="tab-item" data-page="profile"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path></svg><span>我的</span></div>
                </div>

                <!-- 统一的顶部通知条 -->
                <div id="notification-toast" class="absolute top-10 left-1/2 -translate-x-1/2 bg-black bg-opacity-75 text-white px-4 py-2 rounded-full shadow-lg z-50 opacity-0 transform -translate-y-4 transition-all duration-300 pointer-events-none">
                    <p id="notification-text"></p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 管理员桌面视图 -->
    <div id="admin-view" class="hidden">
        <div class="admin-view">
            <!-- 侧边栏 -->
            <nav class="sidebar">
                <div class="p-6 text-center">
                    <h2 class="text-xl font-bold text-white">吊车管理后台</h2>
                </div>
                <div>
                    <a href="#" class="sidebar-item active" data-page="listings"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>信息管理</a>
                    <a href="#" class="sidebar-item" data-page="users"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21a6 6 0 00-9-5.197m0 0A5.975 5.975 0 0112 15a5.975 5.975 0 013-1.197z"></path></svg>用户管理</a>
                    <a href="#" class="sidebar-item" data-page="settings"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>系统设置</a>
                </div>
            </nav>
            <!-- 主内容区 -->
            <main class="main-content">
                <div id="admin-content-listings">
                    <h1 class="text-2xl font-bold text-gray-800 mb-6">信息管理</h1>
                    <div class="bg-white rounded-lg shadow overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="p-3 text-left text-sm font-semibold text-gray-600">编号</th>
                                    <th class="p-3 text-left text-sm font-semibold text-gray-600">标题</th>
                                    <th class="p-3 text-left text-sm font-semibold text-gray-600">价格</th>
                                    <th class="p-3 text-left text-sm font-semibold text-gray-600">状态</th>
                                    <th class="p-3 text-left text-sm font-semibold text-gray-600">操作</th>
                                </tr>
                            </thead>
                            <tbody id="admin-listings-table" class="divide-y divide-gray-200">
                                <!-- JS动态生成 -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div id="admin-content-users" class="hidden">
                    <h1 class="text-2xl font-bold text-gray-800 mb-6">用户管理</h1>
                     <div class="bg-white rounded-lg shadow overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="p-3 text-left text-sm font-semibold text-gray-600">用户ID</th>
                                    <th class="p-3 text-left text-sm font-semibold text-gray-600">头像/昵称</th>
                                    <th class="p-3 text-left text-sm font-semibold text-gray-600">联系电话</th>
                                    <th class="p-3 text-left text-sm font-semibold text-gray-600">注册时间</th>
                                    <th class="p-3 text-left text-sm font-semibold text-gray-600">状态</th>
                                    <th class="p-3 text-left text-sm font-semibold text-gray-600">操作</th>
                                </tr>
                            </thead>
                            <tbody id="admin-users-table" class="divide-y divide-gray-200">
                                <!-- JS动态生成 -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div id="admin-content-settings" class="hidden">
                     <h1 class="text-2xl font-bold text-gray-800 mb-6">系统设置</h1>
                     <div class="space-y-6">
                        <!-- 常规设置 -->
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-lg font-semibold text-gray-700 border-b pb-3 mb-4">常规设置</h3>
                            <div class="space-y-4">
                                <div>
                                    <label for="site-name" class="block text-sm font-medium text-gray-700">小程序名称</label>
                                    <input type="text" id="site-name" value="二手吊车小程序" class="mt-1 block w-full md:w-1/2 form-input">
                                </div>
                                <div>
                                    <label for="admin-email" class="block text-sm font-medium text-gray-700">管理员邮箱</label>
                                    <input type="email" id="admin-email" value="admin@example.com" class="mt-1 block w-full md:w-1/2 form-input">
                                </div>
                            </div>
                        </div>

                        <!-- 内容审核 -->
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-lg font-semibold text-gray-700 border-b pb-3 mb-4">内容审核</h3>
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-medium text-gray-700">新发布信息需要审核</p>
                                    <p class="text-sm text-gray-500">开启后，所有用户新发布的信息都将进入“待审核”状态。</p>
                                </div>
                                <label for="approval-toggle" class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="approval-toggle" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-4 peer-focus:ring-blue-300 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                        </div>

                        <!-- 账户安全 -->
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-lg font-semibold text-gray-700 border-b pb-3 mb-4">账户安全</h3>
                            <div class="space-y-4">
                                <div>
                                    <label for="current-password" class="block text-sm font-medium text-gray-700">当前密码</label>
                                    <input type="password" id="current-password" class="mt-1 block w-full md:w-1/2 form-input">
                                </div>
                                <div>
                                    <label for="new-password" class="block text-sm font-medium text-gray-700">新密码</label>
                                    <input type="password" id="new-password" class="mt-1 block w-full md:w-1/2 form-input">
                                </div>
                                 <div>
                                    <label for="confirm-password" class="block text-sm font-medium text-gray-700">确认新密码</label>
                                    <input type="password" id="confirm-password" class="mt-1 block w-full md:w-1/2 form-input">
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-end pt-4">
                            <button id="save-settings-btn" class="bg-indigo-600 text-white px-6 py-2 rounded-lg shadow-lg hover:bg-indigo-700 transition">
                                保存更改
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- 全局弹窗 (共用) -->
    <div id="call-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-xs text-center">
            <div class="p-6"><p class="text-lg font-semibold text-gray-800 mb-1"></p><p class="text-sm text-gray-500">我们将呼叫此号码</p></div>
            <div class="border-t border-gray-200 grid grid-cols-2">
                <button id="cancel-call" class="py-3 text-gray-600">取消</button>
                <button id="confirm-call" class="py-3 text-blue-500 font-semibold border-l border-gray-200">呼叫</button>
            </div>
        </div>
    </div>
    <div id="confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-xs text-center">
            <div class="p-6"><p id="confirm-modal-text" class="text-lg font-semibold text-gray-800 mb-1"></p></div>
            <div class="border-t border-gray-200 grid grid-cols-2">
                <button id="cancel-confirm" class="py-3 text-gray-600">取消</button>
                <button id="confirm-action" class="py-3 text-red-500 font-semibold border-l border-gray-200">确认</button>
            </div>
        </div>
    </div>
    <div id="image-lightbox" class="hidden fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 p-4">
        <span id="close-lightbox" class="absolute top-4 right-6 text-white text-5xl cursor-pointer hover:text-gray-300">&times;</span>
        <img id="lightbox-image" src="" class="max-w-full max-h-full">
    </div>
    <div id="intention-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-end justify-center z-50">
         <div class="modal bg-white w-full max-w-[420px] rounded-t-2xl p-4 max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 id="intention-modal-title" class="text-lg font-bold">添加意向</h3>
                <span id="close-intention-modal" class="text-2xl cursor-pointer">&times;</span>
            </div>
            <div class="flex-grow overflow-y-auto space-y-4 pr-2">
                <div class="grid grid-cols-3 items-center"><label class="col-span-1">设备类型</label><select id="intention-type" class="col-span-2 form-select"></select></div>
                <div class="grid grid-cols-3 items-center"><label class="col-span-1">品牌</label><select id="intention-brand" class="col-span-2 form-select"></select></div>
                <div class="grid grid-cols-3 items-center"><label class="col-span-1">吨位</label><input type="number" id="intention-tonnage" class="col-span-2 form-input" placeholder="不限"></div>
                <div class="grid grid-cols-3 items-center"><label class="col-span-1">排放标准</label><select id="intention-emission" class="col-span-2 form-select"></select></div>
                <div>
                    <label>所在地</label>
                    <div class="mt-2 p-2 bg-gray-100 rounded-md min-h-[40px]" id="intention-locations-display"></div>
                    <div class="flex items-center space-x-2 mt-2">
                         <select id="intention-province" class="form-select flex-1"></select>
                         <select id="intention-city" class="form-select flex-1"></select>
                         <button id="add-location-btn" class="bg-blue-500 text-white px-4 py-2 rounded-md flex-shrink-0">添加</button>
                    </div>
                </div>
            </div>
            <button id="save-intention-btn" class="w-full bg-blue-600 text-white py-3 rounded-lg text-lg font-semibold mt-4">保存意向</button>
         </div>
    </div>

<script>
// --- 全局变量和状态 ---
let isAdminView = false;
let pageHistory = ['index'];
let notificationTimeout;
let currentIntentionLocations = [];
let editingIntentionId = null;

// --- 模拟数据 ---
let mockListings = [
    { id: 1, title: "三一 XCT25L5 - 80吨", tags: ["中介信息", "塔吊", "国五"], type: "汽车吊", brand: "三一", tonnage: 80, manufacture_date: "2025-06", post_date: "6天前发布", location: "江苏 苏州", price: "180.00", phone: "138-0001-0001", images: ["https://images.unsplash.com/photo-1506748686214-e9df14d4d9d0?q=80&w=800&h=600&fit=crop", "https://picsum.photos/seed/crane1-2/800/600", "https://picsum.photos/seed/crane1-3/800/600"], work_hours: 1500, mileage: 25000, contact_person: "王经理", status: 'selling'},
    { id: 2, title: "中联 XCT25L5 - 50吨", tags: ["二手车商", "塔吊", "国五"], type: "汽车吊", brand: "中联重科", tonnage: 50, manufacture_date: "2025-06", post_date: "6天前发布", location: "山东 济南", price: "80.00", phone: "138-0002-0002", images: ["https://images.unsplash.com/photo-1501785888041-af3ef285b470?q=80&w=800&h=600&fit=crop", "https://picsum.photos/seed/crane2-2/800/600"], work_hours: 2200, mileage: 31000, contact_person: "李老板", status: 'selling'},
    { id: 3, title: "徐工 QY25K5 - 25吨", tags: ["车主直卖", "汽车吊", "国六"], type: "汽车吊", brand: "徐工", tonnage: 25, manufacture_date: "2024-01", post_date: "12天前发布", location: "河北 石家庄", price: "65.50", phone: "138-0003-0003", images: ["https://picsum.photos/id/1057/800/600", "https://picsum.photos/id/1058/800/600"], work_hours: 800, mileage: 12000, contact_person: "张师傅", status: 'selling'},
    { id: 4, title: "三一 STC250 - 25吨", tags: ["车主直卖", "汽车吊", "国五"], type: "汽车吊", brand: "三一", tonnage: 25, manufacture_date: "2023-08", post_date: "20天前发布", location: "广东 广州", price: "55.00", phone: "138-0004-0004", images: ["https://picsum.photos/seed/crane4/600/400"], work_hours: 3500, mileage: 45000, contact_person: "陈先生", status: 'reviewing'},
    { id: 5, title: "利勃海尔 LTM 1500 - 500吨", tags: ["中介信息", "履带吊", "国四"], type: "履带吊", brand: "利勃海尔", tonnage: 500, manufacture_date: "2022-01", post_date: "1月前发布", location: "上海 上海市", price: "1200.00", phone: "138-0005-0005", images: ["https://picsum.photos/seed/crane5/600/400"], work_hours: 5000, mileage: 0, contact_person: "赵总", status: 'off' },
];
let mockUsers = [
    {id: 101, nickname: '吊车大王', avatar: 'https://picsum.photos/seed/avatar1/100/100', phone: '138-0001-0001', registration_date: '2023-05-10', status: 'active'},
    {id: 102, nickname: '起重先锋', avatar: 'https://picsum.photos/seed/avatar2/100/100', phone: '138-0002-0002', registration_date: '2023-08-15', status: 'active'},
    {id: 103, nickname: '工程机械', avatar: 'https://picsum.photos/seed/avatar3/100/100', phone: '138-0003-0003', registration_date: '2024-01-20', status: 'banned'},
    {id: 104, nickname: '吊装小王子', avatar: 'https://picsum.photos/seed/avatar4/100/100', phone: '138-0004-0004', registration_date: '2024-03-11', status: 'active'},
];
let mockMyPosts = [
    { id: 3, status: 'selling' },
    { id: 4, status: 'reviewing' },
    { id: 5, status: 'off' },
];
let mockFavorites = [1, 2];
let mockIntentions = [
    { id: 1, type: '汽车吊', brand: '徐工', tonnage: '25', emission: '国六', locations: [{ province: '河北省', city: '不限' }]},
    { id: 2, type: '高空车', brand: '不限', tonnage: '20', emission: '不限', locations: [{ province: '山东省', city: '济南市' }, { province: '江苏省', city: '苏州市' }] }
];
const chinaLocations = {
    "北京市": ["北京市"], "天津市": ["天津市"], "上海市": ["上海市"], "重庆市": ["重庆市"],
    "河北省": ["石家庄市", "唐山市", "秦皇岛市", "邯郸市", "邢台市", "保定市", "张家口市", "承德市", "沧州市", "廊坊市", "衡水市"], "山西省": ["太原市", "大同市", "阳泉市", "长治市", "晋城市", "朔州市", "晋中市", "运城市", "忻州市", "临汾市", "吕梁市"], "辽宁省": ["沈阳市", "大连市", "鞍山市", "抚顺市", "本溪市", "丹东市", "锦州市", "营口市", "阜新市", "辽阳市", "盘锦市", "铁岭市", "朝阳市", "葫芦岛市"], "吉林省": ["长春市", "吉林市", "四平市", "辽源市", "通化市", "白山市", "松原市", "白城市", "延边朝鲜族自治州"], "黑龙江省": ["哈尔滨市", "齐齐哈尔市", "鸡西市", "鹤岗市", "双鸭山市", "大庆市", "伊春市", "佳木斯市", "七台河市", "牡丹江市", "黑河市", "绥化市", "大兴安岭地区"], "江苏省": ["南京市", "无锡市", "徐州市", "常州市", "苏州市", "南通市", "连云港市", "淮安市", "盐城市", "扬州市", "镇江市", "泰州市", "宿迁市"], "浙江省": ["杭州市", "宁波市", "温州市", "嘉兴市", "湖州市", "绍兴市", "金华市", "衢州市", "舟山市", "台州市", "丽水市"], "安徽省": ["合肥市", "芜湖市", "蚌埠市", "淮南市", "马鞍山市", "淮北市", "铜陵市", "安庆市", "黄山市", "滁州市", "阜阳市", "宿州市", "六安市", "亳州市", "池州市", "宣城市"], "福建省": ["福州市", "厦门市", "莆田市", "三明市", "泉州市", "漳州市", "南平市", "龙岩市", "宁德市"], "江西省": ["南昌市", "景德镇市", "萍乡市", "九江市", "新余市", "鹰潭市", "赣州市", "吉安市", "宜春市", "抚州市", "上饶市"], "山东省": ["济南市", "青岛市", "淄博市", "枣庄市", "东营市", "烟台市", "潍坊市", "济宁市", "泰安市", "威海市", "日照市", "临沂市", "德州市", "聊城市", "滨州市", "菏泽市"], "河南省": ["郑州市", "开封市", "洛阳市", "平顶山市", "安阳市", "鹤壁市", "新乡市", "焦作市", "濮阳市", "许昌市", "漯河市", "三门峡市", "南阳市", "商丘市", "信阳市", "周口市", "驻马店市"], "湖北省": ["武汉市", "黄石市", "十堰市", "宜昌市", "襄阳市", "鄂州市", "荆门市", "孝感市", "荆州市", "黄冈市", "咸宁市", "随州市", "恩施土家族苗族自治州"], "湖南省": ["长沙市", "株洲市", "湘潭市", "衡阳市", "邵阳市", "岳阳市", "常德市", "张家界市", "益阳市", "郴州市", "永州市", "怀化市", "娄底市", "湘西土家族苗族自治州"], "广东省": ["广州市", "韶关市", "深圳市", "珠海市", "汕头市", "佛山市", "江门市", "湛江市", "茂名市", "肇庆市", "惠州市", "梅州市", "汕尾市", "河源市", "阳江市", "清远市", "东莞市", "中山市", "潮州市", "揭阳市", "云浮市"], "海南省": ["海口市", "三亚市", "三沙市", "儋州市"], "四川省": ["成都市", "自贡市", "攀枝花市", "泸州市", "德阳市", "绵阳市", "广元市", "遂宁市", "内江市", "乐山市", "南充市", "眉山市", "宜宾市", "广安市", "达州市", "雅安市", "巴中市", "资阳市", "阿坝藏族羌族自治州", "甘孜藏族自治州", "凉山彝族自治州"], "贵州省": ["贵阳市", "六盘水市", "遵义市", "安顺市", "毕节市", "铜仁市", "黔西南布依族苗族自治州", "黔东南苗族侗族自治州", "黔南布依族苗族自治州"], "云南省": ["昆明市", "曲靖市", "玉溪市", "保山市", "昭通市", "丽江市", "普洱市", "临沧市", "楚雄彝族自治州", "红河哈尼族彝族自治州", "文山壮族苗族自治州", "西双版纳傣族自治州", "大理白族自治州", "德宏傣族景颇族自治州", "怒江傈僳族自治州", "迪庆藏族自治州"], "陕西省": ["西安市", "铜川市", "宝鸡市", "咸阳市", "渭南市", "延安市", "汉中市", "榆林市", "安康市", "商洛市"], "甘肃省": ["兰州市", "嘉峪关市", "金昌市", "白银市", "天水市", "武威市", "张掖市", "平凉市", "酒泉市", "庆阳市", "定西市", "陇南市", "临夏回族自治州", "甘南藏族自治州"], "青海省": ["西宁市", "海东市", "海北藏族自治州", "黄南藏族自治州", "海南藏族自治州", "果洛藏族自治州", "玉树藏族自治州", "海西蒙古族藏族自治州"], "台湾省": ["台北市", "新北市", "桃园市", "台中市", "台南市", "高雄市", "基隆市", "新竹市", "嘉义市"], "内蒙古自治区": ["呼和浩特市", "包头市", "乌海市", "赤峰市", "通辽市", "鄂尔多斯市", "呼伦贝尔市", "巴彦淖尔市", "乌兰察布市", "兴安盟", "锡林郭勒盟", "阿拉善盟"], "广西壮族自治区": ["南宁市", "柳州市", "桂林市", "梧州市", "北海市", "防城港市", "钦州市", "贵港市", "玉林市", "百色市", "贺州市", "河池市", "来宾市", "崇左市"], "西藏自治区": ["拉萨市", "日喀则市", "昌都市", "林芝市", "山南市", "那曲市", "阿里地区"], "宁夏回族自治区": ["银川市", "石嘴山市", "吴忠市", "固原市", "中卫市"], "新疆维吾尔自治区": ["乌鲁木齐市", "克拉玛依市", "吐鲁番市", "哈密市", "昌吉回族自治州", "博尔塔拉蒙古自治州", "巴音郭楞蒙古自治州", "阿克苏地区", "克孜勒苏柯尔克孜自治州", "喀什地区", "和田地区", "伊犁哈萨克自治州", "塔城地区", "阿勒泰地区"], "香港特别行政区": ["香港岛", "九龙", "新界"], "澳门特别行政区": ["澳门半岛", "氹仔", "路环"]
};
const equipmentData = {
    '汽车吊': { brands: ['徐工', '三一', '中联重科', '利勃海尔', '多田野'], unit: '吨' },
    '履带吊': { brands: ['徐工', '三一', '抚挖', '日立住友', '德马格'], unit: '吨' },
    '塔吊': { brands: ['中联重科', '永茂', '马尼托瓦克', '波坦', '科曼萨'], unit: '型号' },
    '高空车': { brands: ['徐工', '吉尼', '星邦', 'JLG', '欧历胜'], unit: '米' },
    '随车吊': { brands: ['石煤', '徐工', '古河', '帕尔菲格', '希尔博'], unit: '吨' },
};
const emissionOptions = ["不限", "国三", "国四", "国五", "国六"];

// --- DOM 元素 ---
const viewToggleBtn = document.getElementById('view-toggle-btn');
const userView = document.getElementById('user-view');
const adminView = document.getElementById('admin-view');
const adminSidebarItems = document.querySelectorAll('.sidebar-item');
const adminContentPanels = {
    listings: document.getElementById('admin-content-listings'),
    users: document.getElementById('admin-content-users'),
    settings: document.getElementById('admin-content-settings'),
};
const adminListingsTable = document.getElementById('admin-listings-table');
const adminUsersTable = document.getElementById('admin-users-table');

// 用户端 DOM
const screenElement = document.getElementById('screen');
const pages = document.querySelectorAll('.page');
const tabItems = document.querySelectorAll('.tab-item');
const navBar = document.getElementById('nav-bar');
const navTitle = document.getElementById('nav-title');
const backButton = document.getElementById('back-button');
const callModal = document.getElementById('call-modal');
const cancelCallBtn = document.getElementById('cancel-call');
const confirmCallBtn = document.getElementById('confirm-call');
const confirmModal = document.getElementById('confirm-modal');
const confirmModalText = document.getElementById('confirm-modal-text');
const cancelConfirmBtn = document.getElementById('cancel-confirm');
const confirmActionBtn = document.getElementById('confirm-action');
const imageLightbox = document.getElementById('image-lightbox');
const lightboxImage = document.getElementById('lightbox-image');
const closeLightboxBtn = document.getElementById('close-lightbox');
const mainTabBar = document.getElementById('tab-bar');
const detailActionBar = document.getElementById('detail-action-bar');
const intentionModal = document.getElementById('intention-modal');
const notificationToast = document.getElementById('notification-toast');
const notificationText = document.getElementById('notification-text');

// --- 视图切换和管理端逻辑 ---
function toggleView() {
    isAdminView = !isAdminView;
    userView.classList.toggle('hidden', isAdminView);
    adminView.classList.toggle('hidden', !isAdminView);
    viewToggleBtn.textContent = isAdminView ? '切换到用户视图' : '切换到管理员视图';
    
    if (isAdminView) {
        renderAdminContent('listings');
    }
}

function renderAdminContent(page) {
    // 高亮侧边栏
    adminSidebarItems.forEach(item => {
        item.classList.toggle('active', item.dataset.page === page);
    });
    // 显示对应内容面板
    for (const key in adminContentPanels) {
        adminContentPanels[key].classList.toggle('hidden', key !== page);
    }
    // 渲染内容
    if (page === 'listings') {
        renderListingsManagement();
    } else if (page === 'users') {
        renderUserManagement();
    }
}

function renderListingsManagement() {
    if (!adminListingsTable) return;
    adminListingsTable.innerHTML = '';

    const statusMap = { selling: '已上架', reviewing: '待审核', off: '已下架' };
    const statusColorMap = { selling: 'status-selling', reviewing: 'status-reviewing', off: 'status-off' };

    mockListings.forEach(item => {
        const tr = document.createElement('tr');
        tr.className = "hover:bg-gray-50";
        tr.innerHTML = `
            <td class="p-3 text-sm text-gray-700">#${String(item.id).padStart(5, '0')}</td>
            <td class="p-3 text-sm text-gray-700">${item.title}</td>
            <td class="p-3 text-sm text-gray-700">${item.price} 万</td>
            <td class="p-3 text-sm"><span class="status-badge ${statusColorMap[item.status]}">${statusMap[item.status]}</span></td>
            <td class="p-3 text-sm">
                ${item.status === 'reviewing' ? `
                    <button class="action-btn text-green-600 hover:bg-green-100" data-action="approve" data-id="${item.id}">通过</button>
                    <button class="action-btn text-red-600 hover:bg-red-100" data-action="reject" data-id="${item.id}">驳回</button>
                ` : ''}
                <button class="action-btn text-blue-600 hover:bg-blue-100" data-action="edit" data-id="${item.id}">编辑</button>
                <button class="action-btn text-gray-600 hover:bg-gray-100" data-action="delete" data-id="${item.id}">删除</button>
            </td>
        `;
        adminListingsTable.appendChild(tr);
    });

    adminListingsTable.querySelectorAll('.action-btn').forEach(btn => {
        btn.addEventListener('click', handleListingAction);
    });
}

function renderUserManagement() {
    if (!adminUsersTable) return;
    adminUsersTable.innerHTML = '';

    const statusMap = { active: '正常', banned: '已封禁' };
    const statusColorMap = { active: 'status-active', banned: 'status-banned' };

    mockUsers.forEach(user => {
        const tr = document.createElement('tr');
        tr.className = "hover:bg-gray-50";
        tr.innerHTML = `
            <td class="p-3 text-sm text-gray-700">#${user.id}</td>
            <td class="p-3 text-sm text-gray-700">
                <div class="flex items-center">
                    <img src="${user.avatar}" class="w-8 h-8 rounded-full object-cover mr-3">
                    <span>${user.nickname}</span>
                </div>
            </td>
            <td class="p-3 text-sm text-gray-700">${user.phone}</td>
            <td class="p-3 text-sm text-gray-700">${user.registration_date}</td>
            <td class="p-3 text-sm"><span class="status-badge ${statusColorMap[user.status]}">${statusMap[user.status]}</span></td>
            <td class="p-3 text-sm">
                ${user.status === 'active' 
                    ? `<button class="action-btn text-red-600 hover:bg-red-100" data-action="ban" data-id="${user.id}">封禁</button>`
                    : `<button class="action-btn text-green-600 hover:bg-green-100" data-action="unban" data-id="${user.id}">解封</button>`
                }
            </td>
        `;
        adminUsersTable.appendChild(tr);
    });

    adminUsersTable.querySelectorAll('.action-btn').forEach(btn => {
        btn.addEventListener('click', handleUserAction);
    });
}

function handleListingAction(e) {
    const { action, id } = e.target.dataset;
    const listing = mockListings.find(item => item.id === parseInt(id));
    if (!listing) return;

    switch(action) {
        case 'approve':
            listing.status = 'selling';
            showNotification(`编号 #${id} 已审核通过并上架。`);
            renderListingsManagement();
            break;
        case 'reject':
            showConfirmModal(`确定要驳回编号 #${id} 吗?`, () => {
                listing.status = 'off';
                showNotification(`编号 #${id} 已被驳回。`);
                renderListingsManagement();
            });
            break;
        case 'edit':
            showNotification(`正在跳转到编号 #${id} 的编辑页面...`);
            setTimeout(() => {
                toggleView();
                navigateTo('post', '编辑信息', parseInt(id));
            }, 500);
            break;
        case 'delete':
            showConfirmModal(`确定要永久删除编号 #${id} 吗?`, () => {
                mockListings = mockListings.filter(item => item.id !== parseInt(id));
                showNotification(`编号 #${id} 已被删除。`);
                renderListingsManagement();
            });
            break;
    }
}

function handleUserAction(e) {
    const { action, id } = e.target.dataset;
    const user = mockUsers.find(u => u.id === parseInt(id));
    if (!user) return;

    if (action === 'ban') {
        showConfirmModal(`确定要封禁用户 “${user.nickname}” 吗?`, () => {
            user.status = 'banned';
            showNotification(`用户 “${user.nickname}” 已被封禁。`);
            renderUserManagement();
        });
    } else if (action === 'unban') {
        user.status = 'active';
        showNotification(`用户 “${user.nickname}” 已解封。`);
        renderUserManagement();
    }
}


// --- 通用辅助函数 ---
function showNotification(text) {
    if (!notificationToast || !notificationText) return;
    notificationText.textContent = text;
    notificationToast.classList.remove('opacity-0', '-translate-y-4');
    clearTimeout(notificationTimeout);
    notificationTimeout = setTimeout(() => {
        notificationToast.classList.add('opacity-0', '-translate-y-4');
    }, 2000);
}
function updateTime() {
    const now = new Date();
    document.getElementById('time').textContent = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
}
function populateSelect(selectElement, options) {
    if (!selectElement) return;
    selectElement.innerHTML = '';
    options.forEach(option => {
        const optionElement = document.createElement('option');
        if (typeof option === 'object') {
            optionElement.value = option.name;
            optionElement.textContent = option.name;
        } else {
            optionElement.value = option;
            optionElement.textContent = option;
        }
        selectElement.appendChild(optionElement);
    });
}

// --- 用户端导航逻辑 ---
function showPage(pageId, title) {
    pages.forEach(p => p.classList.remove('active'));
    navBar.classList.add('hidden');
    mainTabBar.classList.add('hidden');
    detailActionBar.classList.add('hidden');
    const targetPage = document.getElementById(`page-${pageId}`);
    if (targetPage) {
        targetPage.classList.add('active');
        if (['index', 'post', 'profile'].includes(pageId)) {
            mainTabBar.classList.remove('hidden');
        } else {
            navBar.classList.remove('hidden');
            navTitle.textContent = title || '详情';
            if(pageId === 'detail') {
                detailActionBar.classList.remove('hidden');
            }
        }
    }
    updateTabActive(pageId);
    screenElement.scrollTop = 0;
}
function navigateTo(pageId, title, data = null) {
    pageHistory.push(pageId);
    renderPage(pageId, null, data);
    showPage(pageId, title);
}
function navigateBack() {
    if (pageHistory.length > 1) {
        pageHistory.pop();
        const prevPageId = pageHistory[pageHistory.length - 1];
        const prevPage = document.querySelector(`.tab-item[data-page="${prevPageId}"], .profile-menu > div[data-page="${prevPageId}"]`);
        const prevTitle = prevPage ? (prevPage.querySelector('span') ? prevPage.querySelector('span').textContent : '详情') : '首页';
        renderPage(prevPageId);
        showPage(prevPageId, prevTitle);
    }
}
function switchTab(pageId) {
    pageHistory = [pageId];
    renderPage(pageId);
    showPage(pageId);
}
function updateTabActive(pageId) {
    let isTab = false;
    tabItems.forEach(item => {
        const isActive = item.dataset.page === pageId;
        item.classList.toggle('active', isActive);
        if (isActive) isTab = true;
    });
    if (!isTab) {
         tabItems.forEach(item => item.classList.remove('active'));
    }
}

// --- 用户端弹窗逻辑 ---
function showCallModal(phone) {
    callModal.querySelector('p:first-child').textContent = phone || '138-8888-8888';
    callModal.classList.remove('hidden');
}
function hideCallModal() { callModal.classList.add('hidden'); }
function showConfirmModal(text, onConfirm) {
    confirmModalText.textContent = text;
    confirmActionBtn.onclick = () => {
        onConfirm();
        hideConfirmModal();
    };
    confirmModal.classList.remove('hidden');
}
function hideConfirmModal() { confirmModal.classList.add('hidden'); }
function openLightbox(src) {
    lightboxImage.src = src;
    imageLightbox.classList.remove('hidden');
}
function closeLightbox() { imageLightbox.classList.add('hidden'); }

// --- 用户端意向弹窗逻辑 ---
function openIntentionModal(id = null) {
    editingIntentionId = id;
    const modalTitle = intentionModal.querySelector('#intention-modal-title');
    const typeSelect = intentionModal.querySelector('#intention-type');
    const brandSelect = intentionModal.querySelector('#intention-brand');
    const tonnageInput = intentionModal.querySelector('#intention-tonnage');
    const emissionSelect = intentionModal.querySelector('#intention-emission');
    
    populateSelect(typeSelect, Object.keys(equipmentData));
    populateSelect(emissionSelect, emissionOptions);
    
    typeSelect.onchange = e => {
        const type = e.target.value;
        const brands = equipmentData[type] ? ["不限", ...equipmentData[type].brands] : ["不限"];
        populateSelect(brandSelect, brands);
    };

    if (id !== null) {
        modalTitle.textContent = '修改意向';
        const intention = mockIntentions.find(i => i.id === id);
        typeSelect.value = intention.type;
        tonnageInput.value = intention.tonnage === '不限' ? '' : intention.tonnage;
        emissionSelect.value = intention.emission;
        currentIntentionLocations = [...intention.locations];
        typeSelect.dispatchEvent(new Event('change'));
        brandSelect.value = intention.brand;

    } else {
        modalTitle.textContent = '添加意向';
        currentIntentionLocations = [];
        typeSelect.value = Object.keys(equipmentData)[0];
        tonnageInput.value = '';
        emissionSelect.value = '不限';
        typeSelect.dispatchEvent(new Event('change'));
    }

    setupLocationPicker();
    renderLocationTags();
    intentionModal.classList.remove('hidden');
}
function closeIntentionModal() {
    intentionModal.classList.add('hidden');
    editingIntentionId = null;
}
function setupLocationPicker() {
    const provinceSelect = intentionModal.querySelector('#intention-province');
    const citySelect = intentionModal.querySelector('#intention-city');
    populateSelect(provinceSelect, Object.keys(chinaLocations));
    provinceSelect.onchange = e => {
        const cities = chinaLocations[e.target.value] ? ["不限", ...chinaLocations[e.target.value]] : [];
        populateSelect(citySelect, cities);
    };
    provinceSelect.dispatchEvent(new Event('change'));
}
function renderLocationTags() {
    const displayDiv = intentionModal.querySelector('#intention-locations-display');
    displayDiv.innerHTML = '';
    if (currentIntentionLocations.length === 0) {
        displayDiv.innerHTML = `<span class="text-gray-400">尚未添加地区</span>`;
    }
    currentIntentionLocations.forEach((loc, index) => {
        const tag = document.createElement('span');
        tag.className = 'inline-flex items-center bg-blue-100 text-blue-800 text-sm font-medium mr-2 mb-2 px-2.5 py-1 rounded-full';
        tag.innerHTML = `${loc.province} - ${loc.city} <button class="ml-2 text-blue-600 hover:text-blue-800" data-index="${index}">&times;</button>`;
        tag.querySelector('button').addEventListener('click', e => {
            currentIntentionLocations.splice(parseInt(e.target.dataset.index), 1);
            renderLocationTags();
        });
        displayDiv.appendChild(tag);
    });
}

// --- 用户端图片上传逻辑 ---
function handleImageUpload(event, container, imageUrls = []) {
    const previewsContainer = container.querySelector('.previews-container');
    const uploadTrigger = container.querySelector('.upload-trigger');
    
    previewsContainer.querySelectorAll('.image-preview-item').forEach(item => item.remove());

    const addPreview = (src) => {
        const currentPreviews = previewsContainer.querySelectorAll('.image-preview-item').length;
        if(currentPreviews >= 9) return;

        const previewItem = document.createElement('div');
        previewItem.className = 'w-full h-20 image-preview-item';
        previewItem.innerHTML = `
            <img src="${src}" class="w-full h-full object-cover rounded-md">
            <div class="delete-preview-btn">×</div>
        `;
        previewsContainer.insertBefore(previewItem, uploadTrigger);
        
        previewItem.querySelector('.delete-preview-btn').addEventListener('click', () => {
            previewItem.remove();
            checkUploadLimit(container);
        });
    };

    if (imageUrls.length > 0) {
        imageUrls.forEach(url => addPreview(url));
    } else {
         const files = event.target.files;
         for (const file of files) {
             const reader = new FileReader();
             reader.onload = (e) => addPreview(e.target.result);
             reader.readAsDataURL(file);
        }
    }
    
    if(event.target) event.target.value = '';
    checkUploadLimit(container);
}
function checkUploadLimit(container) {
    const previewsContainer = container.querySelector('.previews-container');
    const uploadTrigger = container.querySelector('.upload-trigger');
    const currentPreviews = previewsContainer.querySelectorAll('.image-preview-item').length;
    uploadTrigger.style.display = currentPreviews >= 9 ? 'none' : 'flex';
}

// --- 页面渲染逻辑 ---
function renderPage(pageId, container, data) {
    const pageContainer = container || document.getElementById(`page-${pageId}`);
    switch(pageId) {
        case 'index': renderIndexPage(pageContainer); break;
        case 'post': renderPostPage(pageContainer, data); break;
        case 'profile': renderProfilePage(pageContainer); break;
        case 'favorites': renderFavoritesPage(pageContainer); break;
        case 'posts': renderPostsPage(pageContainer); break;
        case 'intentions': renderIntentionsPage(pageContainer); break;
        case 'report': renderReportPage(pageContainer); break;
        case 'detail': renderDetailPage(data); break;
    }
}
function renderIndexPage(container) {
    container.innerHTML = `
        <div class="w-full">
            <div class="bg-white p-4 border-b border-gray-200">
                <div class="filter-toggle flex justify-between items-center cursor-pointer">
                    <span class="text-base font-medium text-gray-800">展开筛选</span>
                    <div class="filter-arrow"></div>
                </div>
                <div class="filter-content hidden mt-4 space-y-4">
                     <div class="grid grid-cols-5 gap-2 items-center"><label class="col-span-1 text-sm text-gray-600">地区:</label><select class="province-select col-span-2 form-select"></select><select class="city-select col-span-2 form-select"></select></div>
                     <div class="grid grid-cols-5 gap-2 items-center"><label class="col-span-1 text-sm text-gray-600">类型:</label><select class="type-select col-span-4 form-select"></select></div>
                     <div class="grid grid-cols-5 gap-2 items-center"><label class="col-span-1 text-sm text-gray-600">品牌:</label><select class="brand-select col-span-4 form-select"></select></div>
                     <div class="grid grid-cols-5 gap-2 items-center"><label id="spec-label" class="col-span-1 text-sm text-gray-600">规格:</label><input class="spec-input col-span-4 form-input" placeholder="请先选择类型" /></div>
                     <div class="grid grid-cols-5 gap-2 items-center"><label class="col-span-1 text-sm text-gray-600">排放:</label><select class="emission-select col-span-4 form-select"></select></div>
                     <div class="flex space-x-4 mt-4"><button class="flex-1 bg-yellow-500 text-white py-2 rounded-md">重置</button><button class="flex-1 bg-blue-500 text-white py-2 rounded-md">筛选</button></div>
                </div>
            </div>
            <div class="listings-container p-3 space-y-3"></div>
        </div>
    `;
    renderListings(container.querySelector('.listings-container'), mockListings.filter(l => l.status === 'selling'));
    
    container.querySelector('.filter-toggle').addEventListener('click', (e) => {
        const content = container.querySelector('.filter-content');
        const arrow = e.currentTarget.querySelector('.filter-arrow');
        const label = e.currentTarget.querySelector('span');
        content.classList.toggle('hidden');
        arrow.classList.toggle('up');
        label.textContent = content.classList.contains('hidden') ? "展开筛选" : "收起筛选";
    });
    
    const provinceSelect = container.querySelector('.province-select');
    const citySelect = container.querySelector('.city-select');
    const typeSelect = container.querySelector('.type-select');
    const brandSelect = container.querySelector('.brand-select');
    const specInput = container.querySelector('.spec-input');
    const specLabel = container.querySelector('#spec-label');
    populateSelect(provinceSelect, ["不限", ...Object.keys(chinaLocations)]);
    populateSelect(citySelect, ['不限']);
    citySelect.disabled = true;
    provinceSelect.addEventListener('change', (e) => {
        const cities = chinaLocations[e.target.value] ? ["不限", ...chinaLocations[e.target.value]] : ["不限"];
        populateSelect(citySelect, cities);
        citySelect.disabled = (e.target.value === '不限');
    });
    
    const equipmentTypesForFilter = ['不限', ...Object.keys(equipmentData)];
    populateSelect(typeSelect, equipmentTypesForFilter);
    
    const allBrands = ["不限", ...new Set(Object.values(equipmentData).flatMap(type => type.brands))];
    populateSelect(brandSelect, allBrands);
    
    typeSelect.addEventListener('change', (e) => {
        const selectedType = e.target.value;
        const data = equipmentData[selectedType];
        
        if (data) {
            populateSelect(brandSelect, ["不限", ...data.brands]);
        } else {
            populateSelect(brandSelect, allBrands);
        }

        if(data) {
            specLabel.textContent = data.unit === '型号' ? '型号:' : `${data.unit}:`;
            specInput.placeholder = `请输入${data.unit}`;
        } else {
             specLabel.textContent = '规格:';
             specInput.placeholder = '请先选择类型';
        }
    });

    populateSelect(container.querySelector('.emission-select'), emissionOptions);
}
function renderListings(container, list) {
    if (!container) return;
    container.innerHTML = '';
    if (list.length === 0) {
        container.innerHTML = `<p class="text-center text-gray-500 p-8">没有找到符合条件的车辆</p>`;
        return;
    }
    list.forEach(item => {
        const div = document.createElement('div');
        div.className = 'bg-white rounded-lg p-3 shadow-sm relative overflow-hidden cursor-pointer';
        div.dataset.id = item.id;
        div.innerHTML = `
            <div class="absolute top-3 left-3 bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded-full">${item.tags[0]}</div>
            <img src="${item.images[0]}" alt="${item.title}" class="w-full h-40 object-cover rounded-md mb-3" onerror="this.onerror=null;this.src='https://placehold.co/800x600/ccc/FFF?text=Image+Not+Found';">
            <div class="space-y-2">
                <h3 class="text-lg font-bold text-gray-800">${item.title}</h3>
                <div class="flex space-x-2">
                    <span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded">${item.tags[1]}</span>
                    <span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded">${item.tags[2]}</span>
                </div>
                <div class="text-xs text-gray-500 space-y-1">
                    <p>出厂日期: ${item.manufacture_date}</p><p>发布时间: ${item.post_date}</p><p>所在地区: ${item.location}</p>
                </div>
                <div class="flex justify-between items-center pt-2">
                    <span class="text-xl font-bold text-red-500">${item.price}万</span>
                    <button class="call-btn bg-blue-500 text-white text-sm px-4 py-2 rounded-full" data-phone="${item.phone}">拨打电话</button>
                </div>
            </div>
        `;
        div.addEventListener('click', (e) => {
            if (!e.target.closest('.call-btn')) {
               navigateTo('detail', '车辆详情', parseInt(e.currentTarget.dataset.id));
            }
        });
        container.appendChild(div);
    });
}
function renderDetailPage(id) {
    const pageDetail = document.getElementById('page-detail');
    const item = mockListings.find(i => i.id === id);
    if (!item) return;

    const serialNumber = String(item.id).padStart(5, '0');

    let imageSlides = item.images.map(imgUrl => `
        <div class="flex-shrink-0 w-full h-full carousel-slide">
            <img src="${imgUrl}" class="w-full h-full object-cover cursor-pointer" onerror="this.onerror=null;this.src='https://placehold.co/800x600/ccc/FFF?text=Image+Not+Found';">
        </div>
    `).join('');

    const isFavorited = mockFavorites.includes(id);

    pageDetail.innerHTML = `
        <div class="w-full bg-gray-100 pb-20">
            <div class="relative w-full h-64 bg-black overflow-hidden">
                <div class="flex h-full carousel-container">${imageSlides}</div>
            </div>
            <div class="bg-white p-4 -mt-2 rounded-t-lg">
                <div class="flex justify-between items-start">
                    <h2 class="text-xl font-bold text-gray-800">${item.title}</h2>
                    <span class="text-sm text-gray-400 font-mono flex-shrink-0 ml-2 pt-1">编号: #${serialNumber}</span>
                </div>
                <p class="text-2xl font-bold text-red-500 my-2">${item.price} 万</p>
                <div class="flex space-x-2 my-3">
                    <span class="bg-gray-100 text-gray-700 text-xs font-medium px-2.5 py-1 rounded">${item.type}</span>
                    <span class="bg-gray-100 text-gray-700 text-xs font-medium px-2.5 py-1 rounded">${item.tags[2]}</span>
                </div>
            </div>
            <div class="bg-white p-4 mt-2">
                <h3 class="font-semibold text-base mb-3 border-l-4 border-blue-500 pl-2">详细信息</h3>
                <div class="grid grid-cols-2 gap-y-3 text-gray-600 text-sm">
                    <p><strong>设备品牌:</strong> ${item.brand}</p>
                    <p><strong>设备型号:</strong> ${item.title.split(' - ')[0]}</p>
                    <p><strong>工作小时:</strong> ${item.work_hours} 小时</p>
                    <p><strong>行驶里程:</strong> ${item.mileage > 0 ? `${item.mileage} 公里` : '无'}</p>
                    <p><strong>出厂日期:</strong> ${item.manufacture_date}</p>
                    <p><strong>排放标准:</strong> ${item.tags[2]}</p>
                    <p><strong>所在地区:</strong> ${item.location}</p>
                    <p><strong>发布时间:</strong> ${item.post_date}</p>
                </div>
            </div>
             <div class="bg-white p-4 mt-2">
                <h3 class="font-semibold text-base mb-3 border-l-4 border-blue-500 pl-2">联系方式</h3>
                <div class="grid grid-cols-2 gap-y-3 text-gray-600 text-sm">
                     <p><strong>联系人:</strong> ${item.contact_person}</p>
                     <p><strong>联系电话:</strong> ${item.phone}</p>
                </div>
            </div>
            <div class="bg-white p-4 mt-2">
                 <h3 class="font-semibold text-base mb-3 border-l-4 border-blue-500 pl-2">详情描述</h3>
                 <p class="text-gray-600 text-sm leading-relaxed">车况良好，保养到位，手续齐全，个人一手车，随时可以看车...</p>
            </div>
        </div>
    `;
    
    detailActionBar.innerHTML = `
        <div class="h-full bg-white p-2 flex justify-between items-center text-sm text-gray-600">
             <div class="flex items-center space-x-4 pl-2">
                <span class="fav-btn cursor-pointer flex flex-col items-center" data-id="${id}">
                   <svg class="w-6 h-6 mb-1 ${isFavorited ? 'text-yellow-500' : 'text-gray-500'}" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                   <span>${isFavorited ? '已收藏' : '收藏'}</span>
                </span>
                <span class="share-btn cursor-pointer flex flex-col items-center">
                   <svg class="w-6 h-6 mb-1 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12s-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.368a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path></svg>
                   <span>分享</span>
                </span>
                <span class="report-btn cursor-pointer flex flex-col items-center">
                    <svg class="w-6 h-6 mb-1 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span>举报</span>
                </span>
             </div>
             <button class="call-btn bg-blue-500 text-white py-3 px-8 rounded-full text-base font-semibold" data-phone="${item.phone}">一键拨号</button>
        </div>
    `;

    pageDetail.querySelectorAll('.carousel-slide img').forEach(img => img.addEventListener('click', () => openLightbox(img.src)));
    
    detailActionBar.querySelector('.report-btn').addEventListener('click', () => {
        navigateTo('report', '信息举报');
    });
    detailActionBar.querySelector('.share-btn').addEventListener('click', () => showNotification('已模拟分享操作'));
    detailActionBar.querySelector('.fav-btn').addEventListener('click', (e) => {
        const btn = e.currentTarget;
        const carId = parseInt(btn.dataset.id);
        const favIndex = mockFavorites.indexOf(carId);
        const isFavorited = favIndex > -1;

        if (isFavorited) {
            mockFavorites.splice(favIndex, 1);
        } else {
            mockFavorites.push(carId);
        }
        
        btn.innerHTML = `
            <svg class="w-6 h-6 mb-1 ${!isFavorited ? 'text-yellow-500' : 'text-gray-500'}" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
            <span>${!isFavorited ? '已收藏' : '收藏'}</span>
        `;
        showNotification(!isFavorited ? '收藏成功' : '已取消收藏');
    });
}
function renderPostPage(container, postToEditId = null) {
    const isEditing = postToEditId !== null;
    const postToEdit = isEditing ? mockListings.find(p => p.id === postToEditId) : null;
    const submitButtonText = isEditing ? '保存修改' : '提交审核';
    
    container.innerHTML = `
        <div class="w-full p-4 space-y-4 bg-white min-h-full">
            <div class="p-4 bg-gray-50 rounded-lg">
                <p class="font-medium text-gray-700 mb-2">车辆照片 (最多9张)</p>
                <div class="previews-container grid grid-cols-4 gap-3">
                    <input type="file" class="image-upload hidden" multiple accept="image/*">
                    <div class="upload-trigger w-full h-20 bg-gray-200 rounded-md flex items-center justify-center cursor-pointer">
                        <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    </div>
                </div>
            </div>
            
            <div class="space-y-4">
                <div class="grid grid-cols-3 items-center"><label class="col-span-1">发布者身份</label><select id="post-identity-select" class="col-span-2 form-select"><option>车主</option><option>中介</option><option>二手车商</option></select></div>
                <div class="grid grid-cols-3 items-center"><label class="col-span-1">设备类型</label><select id="post-type-select" class="col-span-2 form-select"></select></div>
                <div class="grid grid-cols-3 items-center"><label class="col-span-1">品牌</label><select id="post-brand-select" class="col-span-2 form-select"></select></div>
                <div class="grid grid-cols-3 items-center"><label class="col-span-1">型号</label><input id="post-model-input" class="col-span-2 form-input" placeholder="请输入型号"></div>
                <div class="grid grid-cols-3 items-center"><label id="post-spec-label" class="col-span-1">规格</label><input type="number" id="post-spec-input" class="col-span-2 form-input" placeholder="请选择类型"></div>
                <div class="grid grid-cols-3 items-center"><label class="col-span-1">价格(万)</label><input type="number" id="post-price-input" class="col-span-2 form-input" placeholder="留空则显示“面议”"></div>
                <div class="grid grid-cols-3 items-center"><label class="col-span-1">所在地</label><div class="col-span-2 grid grid-cols-2 gap-2"><select id="post-province-select" class="form-select"></select><select id="post-city-select" class="form-select"></select></div></div>
                <div class="grid grid-cols-3 items-center"><label class="col-span-1">出厂日期</label><input id="post-date-input" type="month" class="col-span-2 form-input"></div>
                <div class="grid grid-cols-3 items-center"><label class="col-span-1">排放标准</label><select id="post-emission-select" class="col-span-2 form-select"></select></div>
                <div class="grid grid-cols-3 items-center"><label class="col-span-1">工作小时</label><input id="post-work-hours" type="number" class="col-span-2 form-input" placeholder="请输入工作小时"></div>
                <div class="grid grid-cols-3 items-center"><label class="col-span-1">行驶里程</label><input id="post-mileage" type="number" class="col-span-2 form-input" placeholder="请输入行驶里程(公里)"></div>
                <div><label>车况描述</label><textarea class="form-textarea mt-2" rows="4" placeholder="请输入车况描述..."></textarea></div>
                <div class="grid grid-cols-3 items-center"><label class="col-span-1">联系人</label><input id="post-contact-person" class="col-span-2 form-input" placeholder="请输入联系人姓名"></div>
                <div class="grid grid-cols-3 items-center"><label class="col-span-1">联系电话</label><input id="post-phone" type="tel" class="col-span-2 form-input" placeholder="请输入联系电话"></div>
            </div>
            
            <button id="save-post-btn" class="w-full bg-blue-500 text-white py-3 rounded-lg text-lg font-semibold mt-6">${submitButtonText}</button>
        </div>
    `;
    const uploadTrigger = container.querySelector('.upload-trigger');
    const imageUploadInput = container.querySelector('.image-upload');
    uploadTrigger.addEventListener('click', () => imageUploadInput.click());
    imageUploadInput.addEventListener('change', (e) => handleImageUpload(e, container));
    
    const typeSelect = container.querySelector('#post-type-select');
    const brandSelect = container.querySelector('#post-brand-select');
    const specLabel = container.querySelector('#post-spec-label');
    const specInput = container.querySelector('#post-spec-input');
    const provinceSelect = container.querySelector('#post-province-select');
    const citySelect = container.querySelector('#post-city-select');

    populateSelect(typeSelect, Object.keys(equipmentData));
    typeSelect.addEventListener('change', e => {
        const type = e.target.value;
        const data = equipmentData[type];
        populateSelect(brandSelect, data ? data.brands : []);
        specLabel.textContent = data ? `${data.unit}:` : `规格:`;
        specInput.placeholder = data ? `请输入${data.unit}` : `请选择类型`;
    });
    
    populateSelect(provinceSelect, Object.keys(chinaLocations));
    provinceSelect.addEventListener('change', e => {
        populateSelect(citySelect, chinaLocations[e.target.value] || []);
    });
    
    populateSelect(container.querySelector('#post-emission-select'), emissionOptions.slice(1));
    
    if(isEditing && postToEdit) {
        typeSelect.value = postToEdit.type;
        typeSelect.dispatchEvent(new Event('change'));
        brandSelect.value = postToEdit.brand;
        container.querySelector('#post-model-input').value = postToEdit.title.split(' - ')[0]; 
        specInput.value = postToEdit.tonnage;
        container.querySelector('#post-price-input').value = postToEdit.price;
        container.querySelector('#post-work-hours').value = postToEdit.work_hours;
        container.querySelector('#post-mileage').value = postToEdit.mileage;
        container.querySelector('#post-contact-person').value = postToEdit.contact_person;
        container.querySelector('#post-phone').value = postToEdit.phone;
        const [province, city] = postToEdit.location.split(' ');
        provinceSelect.value = Object.keys(chinaLocations).find(p => p.startsWith(province));
        provinceSelect.dispatchEvent(new Event('change'));
        citySelect.value = city;
        container.querySelector('#post-date-input').value = postToEdit.manufacture_date;
        container.querySelector('#post-emission-select').value = postToEdit.tags[2];
        handleImageUpload({ target: { files: [] }}, container, postToEdit.images);
    } else {
         typeSelect.dispatchEvent(new Event('change'));
         provinceSelect.dispatchEvent(new Event('change'));
    }

    container.querySelector('#save-post-btn').addEventListener('click', () => {
         showNotification(isEditing ? '修改已保存' : '已提交审核');
         navigateBack();
    });
}
function renderProfilePage(container) {
    container.innerHTML = `
         <div class="w-full">
             <div class="p-6 bg-white flex items-center space-x-4">
                 <img src="https://picsum.photos/seed/avatar/80/80" class="w-20 h-20 rounded-full object-cover" alt="avatar" />
                 <div>
                     <p class="text-xl font-bold">吊车大王</p>
                     <p class="text-sm text-gray-500 mt-1">ID: user_123456</p>
                 </div>
             </div>
             <div class="mt-4 bg-white profile-menu">
                 <div class="p-4 border-b border-gray-200 flex justify-between items-center cursor-pointer" data-page="favorites"><span>我的收藏</span><span>&gt;</span></div>
                 <div class="p-4 border-b border-gray-200 flex justify-between items-center cursor-pointer" data-page="posts"><span>我的发布</span><span>&gt;</span></div>
                 <div class="p-4 border-b border-gray-200 flex justify-between items-center cursor-pointer" data-page="intentions"><span>意向车型</span><span>&gt;</span></div>
             </div>
         </div>
    `;
    container.querySelector('.profile-menu').addEventListener('click', (e) => {
        const target = e.target.closest('div[data-page]');
        if (target) {
            const pageId = target.dataset.page;
            const title = target.querySelector('span').textContent;
            navigateTo(pageId, title);
        }
    });
}
function renderReportPage(container) {
    container.innerHTML = `
        <div class="w-full p-4 space-y-5">
            <div class="bg-blue-50 p-3 rounded-lg text-sm text-blue-700"><strong>说明:</strong> 坚决禁止非法、虚假等信息，您的投诉我们会认真查实并根据平台协议进行落实！</div>
            <div class="bg-white p-4 rounded-lg space-y-4"><p class="font-semibold">车辆信息</p>
                <label class="flex items-center space-x-3"><input type="radio" name="report_reason" class="form-radio h-5 w-5 text-blue-600" checked><span>虚假信息</span></label>
                <label class="flex items-center space-x-3"><input type="radio" name="report_reason" class="form-radio h-5 w-5 text-blue-600"><span>车辆已售</span></label>
                <label class="flex items-center space-x-3"><input type="radio" name="report_reason" class="form-radio h-5 w-5 text-blue-600"><span>中介车源/车主车源 标识错误</span></label>
            </div>
            <div class="bg-white p-4 rounded-lg"><p class="font-semibold mb-2">投诉理由</p><textarea class="w-full h-32 p-2 bg-gray-50 rounded-md focus:outline-none" placeholder="请输入您的举报理由..."></textarea></div>
            <button class="w-full bg-blue-500 text-white py-3 rounded-lg text-lg font-semibold">提交</button>
            <p class="text-xs text-gray-500 mt-2">*免责声明: 平台仅提供信息展示服务, 内容真实性由用户自行审核, 自行负责。</p>
        </div>
    `;
}
function renderFavoritesPage(page) {
    const favList = mockListings.filter(item => mockFavorites.includes(item.id));
    
    if (favList.length === 0) {
        page.innerHTML = `<div class="text-center p-10 text-gray-500">你还没有收藏任何车辆</div>`;
        return;
    }

    let content = '<div class="p-3 space-y-3">';
    favList.forEach(item => {
        content += `
         <div class="bg-white rounded-lg p-3 shadow-sm flex items-center space-x-4">
             <div class="flex-1 flex items-center space-x-4 cursor-pointer item-link" data-id="${item.id}">
                 <img src="${item.images[0]}" class="w-24 h-24 object-cover rounded-md flex-shrink-0" onerror="this.onerror=null;this.src='https://placehold.co/200/ccc/FFF?text=N/A';">
                 <div class="flex-1">
                     <h4 class="font-bold text-gray-800">${item.title}</h4>
                     <p class="text-sm text-gray-500">${item.location}</p>
                     <p class="text-lg font-bold text-red-500 mt-2">${item.price}万</p>
                 </div>
             </div>
             <button class="unfav-btn text-sm bg-gray-200 px-3 py-1 rounded-full flex-shrink-0" data-id="${item.id}">取消收藏</button>
        </div>`;
    });
    content += '</div>';
    page.innerHTML = content;
    
    page.querySelectorAll('.item-link').forEach(link => {
        link.addEventListener('click', e => {
            const carId = parseInt(e.currentTarget.dataset.id);
            navigateTo('detail', '车辆详情', carId);
        });
    });

    page.querySelectorAll('.unfav-btn').forEach(btn => btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const carId = parseInt(e.target.dataset.id);
        showConfirmModal('确定要取消收藏吗?', () => {
            const favIndex = mockFavorites.indexOf(carId);
            if (favIndex > -1) {
                mockFavorites.splice(favIndex, 1);
                renderFavoritesPage(page); 
            }
        });
    }));
}
function renderPostsPage(page) {
    let content = '<div class="p-3 space-y-3">';
    const userPostings = mockListings.filter(listing => mockMyPosts.some(p => p.id === listing.id));
    
    userPostings.forEach(item => {
        const statusMap = { selling: '已上架', reviewing: '审核中', off: '已下架' };
        const statusColor = { selling: 'text-green-600', reviewing: 'text-yellow-600', off: 'text-gray-500' };

        content += `
         <div class="bg-white rounded-lg p-3 shadow-sm">
             <div class="flex space-x-4">
                 <img src="${item.images[0]}" class="w-24 h-24 object-cover rounded-md" onerror="this.onerror=null;this.src='https://placehold.co/200/ccc/FFF?text=N/A';">
                 <div class="flex-1">
                     <h4 class="font-bold text-gray-800">${item.title}</h4>
                     <p class="text-sm font-semibold ${statusColor[item.status]} mt-2">${statusMap[item.status]}</p>
                 </div>
             </div>
             <div class="border-t border-gray-100 mt-3 pt-3 flex justify-end space-x-2">
                 ${item.status === 'off' ? `<button class="post-action-btn" data-action="list" data-id="${item.id}">上架</button>` : ''}
                 ${item.status === 'selling' ? `<button class="post-action-btn" data-action="unlist" data-id="${item.id}">下架</button>` : ''}
                 <button class="post-action-btn" data-action="edit" data-id="${item.id}">编辑</button>
                 <button class="post-action-btn text-red-500" data-action="delete" data-id="${item.id}">删除</button>
             </div>
        </div>`;
    });
    content += '</div>';
    page.innerHTML = content;
    
    page.querySelectorAll('.post-action-btn').forEach(btn => btn.addEventListener('click', e => {
        const action = e.target.dataset.action;
        const id = parseInt(e.target.dataset.id);
        const post = mockListings.find(p => p.id === id);

        if (action === 'delete') {
             showConfirmModal('确定要删除吗？', () => {
                 mockListings = mockListings.filter(p => p.id !== id);
                 mockMyPosts = mockMyPosts.filter(p => p.id !== id);
                 renderPostsPage(page);
             });
        } else if (action === 'list') {
             if (post) {
                 post.status = 'selling';
                 renderPostsPage(page);
             }
        } else if (action === 'unlist') {
             if (post) {
                 post.status = 'off';
                 renderPostsPage(page);
             }
        } else if (action === 'edit') {
             navigateTo('post', '编辑信息', id);
        }
    }));
}
function renderIntentionsPage(page) {
    let content = `<div class="p-3 space-y-3">
        <button id="add-intention-btn-page" class="w-full bg-blue-500 text-white py-3 rounded-lg font-semibold">添加意向车型</button>
    `;
    mockIntentions.forEach(item => {
        const locationsText = item.locations.map(loc => `${loc.province}-${loc.city}`).join(', ');
        content += `
        <div class="bg-white rounded-lg p-4 shadow-sm">
            <div class="flex justify-between items-start">
                <div>
                    <h4 class="font-bold text-lg">${item.brand} - ${item.type}</h4>
                    <p class="text-sm text-gray-600">规格: ${item.tonnage || '不限'} | 排放: ${item.emission}</p>
                    <p class="text-sm text-gray-600 mt-1">地区: ${locationsText}</p>
                </div>
                <div class="flex space-x-2 flex-shrink-0 pl-2">
                    <button class="edit-intention-btn text-sm text-blue-500" data-id="${item.id}">修改</button>
                    <button class="delete-intention-btn text-sm text-red-500" data-id="${item.id}">删除</button>
                </div>
            </div>
        </div>
        `;
    });
    content += '</div>';
    page.innerHTML = content;
    
    page.querySelector('#add-intention-btn-page').addEventListener('click', () => openIntentionModal());
    page.querySelectorAll('.edit-intention-btn').forEach(btn => btn.addEventListener('click', e => {
        const id = parseInt(e.target.dataset.id);
        openIntentionModal(id);
    }));
    page.querySelectorAll('.delete-intention-btn').forEach(btn => btn.addEventListener('click', e => {
        showConfirmModal('确定要删除此意向吗?', () => {
            const id = parseInt(e.target.dataset.id);
            mockIntentions = mockIntentions.filter(i => i.id !== id);
            renderIntentionsPage(page);
        });
    }));
}


// --- 应用初始化 ---
function initializeApp() {
    // 全局事件监听
    viewToggleBtn.addEventListener('click', toggleView);
    adminSidebarItems.forEach(item => {
        item.addEventListener('click', (e) => {
            e.preventDefault();
            renderAdminContent(item.dataset.page);
        });
    });
    adminContentPanels.settings.addEventListener('click', (e) => {
        if (e.target.id === 'save-settings-btn') {
            showNotification('设置已保存！');
        }
    });

    // 用户端事件监听
    tabItems.forEach(tab => tab.addEventListener('click', () => switchTab(tab.dataset.page)));
    backButton.addEventListener('click', navigateBack);
    screenElement.addEventListener('click', (e) => {
        const callButton = e.target.closest('.call-btn');
        if (callButton) {
            e.stopPropagation();
            showCallModal(callButton.dataset.phone);
        }
    });
    detailActionBar.addEventListener('click', (e) => {
        const callButton = e.target.closest('.call-btn');
        if(callButton){
            e.stopPropagation();
            showCallModal(callButton.dataset.phone);
        }
    });
    cancelCallBtn.addEventListener('click', hideCallModal);
    confirmCallBtn.addEventListener('click', () => {
        showNotification('模拟呼叫中...');
        hideCallModal();
    });
    cancelConfirmBtn.addEventListener('click', hideConfirmModal);
    closeLightboxBtn.addEventListener('click', closeLightbox);
    intentionModal.querySelector('#close-intention-modal').addEventListener('click', closeIntentionModal);
    intentionModal.querySelector('#add-location-btn').addEventListener('click', () => {
        const province = intentionModal.querySelector('#intention-province').value;
        const city = intentionModal.querySelector('#intention-city').value;
        if(province && city) {
            if (!currentIntentionLocations.some(l => l.province === province && l.city === city)) {
                currentIntentionLocations.push({ province, city });
                renderLocationTags();
            } else {
                showNotification('该地区已添加');
            }
        }
    });
    intentionModal.querySelector('#save-intention-btn').addEventListener('click', () => {
        const newIntention = {
            id: editingIntentionId !== null ? editingIntentionId : Date.now(),
            type: intentionModal.querySelector('#intention-type').value,
            brand: intentionModal.querySelector('#intention-brand').value,
            tonnage: intentionModal.querySelector('#intention-tonnage').value || '不限',
            emission: intentionModal.querySelector('#intention-emission').value,
            locations: [...currentIntentionLocations]
        };
        if(newIntention.locations.length === 0) {
            showNotification('请至少添加一个地区');
            return;
        }
        if (editingIntentionId !== null) {
            const index = mockIntentions.findIndex(i => i.id === editingIntentionId);
            mockIntentions[index] = newIntention;
        } else {
            newIntention.id = Date.now();
            mockIntentions.push(newIntention);
        }
        renderIntentionsPage(document.getElementById('page-intentions'));
        closeIntentionModal();
    });

    // 初始加载
    updateTime();
    setInterval(updateTime, 1000 * 60);
    renderPage('index');
    showPage('index');
}

// --- 应用启动 ---
initializeApp();
</script>

</body>
</html>
